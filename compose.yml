version: "3.9"
name: rmm-databases

networks:
  local:
    driver: "bridge"
    name: ${MYSQL_NETWORK_NAME:-rmm_network}

volumes:
  mysql_db_data:
    driver: "local"
    name: "${MYSQL_DB_VOLUME_DATA_NAME:-rmm_mysql_db}"
    
  pgsql_db_data:
    driver: "local"
    name: "${PGSQL_DB_VOLUME_DATA_NAME:-rmm_pgsql_db}"

  mongodb_db_data:
    driver: "local"
    name: "${MONGO_DB_VOLUME_DATA_NAME:-rmm_mongodb_db}"


services:
  
  # MySQL
  mysql:
    image: mysql:latest
    container_name: "${MYSQL_DB_CONTAINER_NAME}"
    command: --default-authentication-plugin=caching_sha2_password
    env_file:
      - ./.env
    environment:
      MYSQL_ROOT_HOST: "%"
      MYSQL_ROOT_PASSWORD: "${MYSQL_DB_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${MYSQL_DB_DATABASE:-local}"
      # Mysql > 8 
      # https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password
      MYSQL_USER: "${MYSQL_DB_USERNAME}"
      MYSQL_PASSWORD: "${MYSQL_DB_PASSWORD}"
      # MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-p${MYSQL_DB_ROOT_PASSWORD}"]
      retries: 3
      timeout: 5s
    networks:
      - local
    platform: linux/x86_64
    ports:
     - ${MYSQL_DB_PORT:-3306}:3306
    volumes:
      - mysql_db_data:/var/lib/mysql
      - ./databases/mysql/scripts/sakila-schema.sql:/docker-entrypoint-initdb.d/01_sakila-schema.sql
      - ./databases/mysql/scripts/sakila-data.sql:/docker-entrypoint-initdb.d/02_sakila-data.sql
  
  # Postgres
  pgsql:

    image: postgres:latest
    container_name: "${PGSQL_DB_CONTAINER_NAME:-pgsql_db}"
    env_file:
      - ./.env
    environment:
      POSTGRES_DB: "${PGSQL_DB_DATABASE:-local}"
      POSTGRES_USER: "${PGSQL_DB_USERNAME}"
      POSTGRES_PASSWORD: "${PGSQL_DB_PASSWORD}"
    healthcheck:
      test: [
        "CMD", "pg_isready", "-q",
        "-d", "${PGSQL_DB_DATABASE:-local}",
        "-U", "${PGSQL_DB_USERNAME}"
      ]
      retries: 3
      timeout: 5s
    networks:
      - local

    ports:
     - ${PGSQL_DB_PORT:-5432}:5432
    volumes:
      - pgsql_db_data:/var/lib/postgresql/data
      - ./databases/postgres/scripts/sakila-schema.sql:/docker-entrypoint-initdb.d/01_sakila-schema.sql
      - ./databases/postgres/scripts/sakila-data.sql:/docker-entrypoint-initdb.d/02_sakila-data.sql
  
  # Redis
  redis:
    image: redis:latest
    container_name: "${REDIS_DB_CONTAINER_NAME:-redis_db}"
    env_file:
      - ./.env
    command: redis-server --save 20 1 --loglevel warning --requirepass "${REDIS_DB_PASSWORD}"
    ports:
      - ${REDIS_DB_PORT:-6379}:6379
    networks:
      - local

  # MSSQL
  mssql:
    build:
      dockerfile: ./databases/mssql/dockerfile
      context: .
    container_name: "${MSSQL_DB_CONTAINER_NAME:-mssql_db}"
    env_file:
      - ./.env
    environment:
      SA_PASSWORD: "${MSSQL_DB_ROOT_PASSWORD}"
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
      BAK_FILE: "${BAK_FILE}"
    ports:
      - ${MSSQL_DB_PORT:-1433}:1433
    networks:
      - local
  
  # MongoDB
  mongo:
    image: mongo:latest
    container_name: "${MONGO_DB_CONTAINER_NAME:-mongo_db}"
    # command: "mongo -u ${MONGO_DB_USERNAME:-root} -p ${MONGO_DB_PASSWORD} --authenticationDatabase admin"
    env_file:
      - ./.env
    volumes:
      - mongodb_db_data:/data/db
    ports:
      - ${MONGO_DB_PORT:-27017}:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: "${MONGO_DB_USERNAME:-root}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGO_DB_PASSWORD}"
    networks:
      - local

  mongo-express:
    image: mongo-express
    env_file:
      - ./.env
    ports:
      - 9002:8081
    environment:
      ME_CONFIG_MONGODB_URL: "mongodb://${MONGO_DB_USERNAME:-root}:${MONGO_DB_PASSWORD}@mongo:27017/?authSource=admin"
      ME_CONFIG_BASICAUTH_USERNAME: "${MONGO_EXPRESS_USERNAME}"
      ME_CONFIG_BASICAUTH_PASSWORD: "${MONGO_EXPRESS_PASSWORD}"
      ME_CONFIG_MONGODB_PORT: ${MONGO_DB_PORT:-27017}
      ME_CONFIG_MONGODB_ADMINUSERNAME: "${MONGO_DB_USERNAME:-root}"
      ME_CONFIG_MONGODB_ADMINPASSWORD: "${MONGO_DB_PASSWORD}"
      ME_CONFIG_MONGODB_ENABLE_ADMIN: "true"
    links:
      - mongo
    networks:
      - local

  # Adminer
  adminer:
    image: adminer
    container_name: UI-adminer
    restart: always
    ports:
      - 9000:8080
    networks:
      - local

  # PgAdmin
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: UI-pgadmin
    restart: always
    depends_on:
      - pgsql
    environment:
      PGADMIN_DEFAULT_EMAIL: user@localhost.com
      PGADMIN_DEFAULT_PASSWORD: password
    ports:
      - 9001:80
    networks:
      - local
    # volumes:
    #   - ./data/pgadmin:/var/lib/pgadmin      